<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Counter website</title>
        <script type="text/javascript">
            async function incrementValue(amount) {
                count.innerText = count.innerText*1+amount;
                const result = await fetch("/api/increment", {method: 'POST'})
                const jsonResult = await result.json();
                count.innerText = jsonResult.count
            }
            async function updateCountBasedOnApi() {
                const result = await fetch("/api/count")
                const jsonResult = await result.json()
                count.innerText = jsonResult.count;
                if (localStorage.getItem("jwt")) {
                    document.getElementById("adminTools").style.display = "block";
                }
            }
            async function attemptSignIn() {
                const result = await (fetch("/api/login", {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    body: JSON.stringify({username: usernameBox.value, password: passwordBox.value})
                }));
                if (result.status >= 400 && 600 > result.status) {
                    alert("Invalid credentials!");
                    return;
                }
                const textResult = await result.text();
                localStorage.setItem("jwt", textResult);
                window.location.reload();
            }
            async function resetCount() {
                const result = await fetch("/api/reset", {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    body: JSON.stringify({token: localStorage.getItem("jwt")})
                });
            }
            function logout() {
                localStorage.removeItem('jwt');
                window.location.reload()
            }
            updateCountBasedOnApi()
        </script>
        <link rel="stylesheet" href="/style.css">
    </head>
    <body>
        <h1>Counter</h1>
        <p>Click to increment the counter</p>
        <button onclick="incrementValue(1)" id="count">loading...</button>
        <button onclick="updateCountBasedOnApi()" id="update">refresh</button>
        <br><br>
        <p>Admin sign in</p>
        <input type="text" placeholder="Username" id="usernameBox" autocomplete="off"/>
        <input type="password" placeholder="Password" id="passwordBox" autocomplete="off"/>
        <button id="signIn" onclick="attemptSignIn(); updateCountBasedOnApi()">Sign In</button>
        <div id="adminTools">
            <br><br>
            <p>Admin tools</p>
            <button id="resetCountButton" onclick="resetCount(); updateCountBasedOnApi()">Reset count</button>
            <button id="logoutButton" onclick="logout()">Logout</button>
        </div>
    </body>
</html>
